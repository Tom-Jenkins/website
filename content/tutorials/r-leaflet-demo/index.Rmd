---
title: "An introduction to R Leaflet"
date: '2021-12-21'
diagram: yes
math: yes
slug: r-leaflet-introduction
summary: This demo covers how to develop interactive maps using R and Leaflet.
categories: ["R"]
weight: 1
image:
  placement: 1
  caption: ''
  preview_only: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(collapse = TRUE)
```

```{css, echo=FALSE}
pre {
  max-height: 300px;
  overflow-y: auto;
}
```

<div id="contents"/>
## Contents
1. [My first Leaflet map](#1)
1. [Add point data](#2)
1. [Add polygon data](#3)
1. [Add popup graphs and images](#4)
1. [Add extra customisation and widgets](#5)
1. [Final map](#6)
1. [Further resources and R session info](#7)

<div id="1"/>
### 1. My first Leaflet map

[Leaflet](https://leafletjs.com/) is an open-source JavaScript library for creating interactive maps. It supports vector and raster GIS data and has lots of plugins, widgets and customisation options. R users can access most of the features of Leaflet though the RStudio [leaflet package](https://github.com/rstudio/leaflet). In this demo, we will cover some of the basics of R Leaflet and introduce adding and customising basemaps, feature layers and interactive widgets to your Leaflet map, with a particular focus on code that I've found most useful to-date.

#### Install and load R packages
```{r warning=FALSE, message=FALSE}
library(leaflet)
library(leafpop)
library(leaflet.extras)
library(htmltools)
library(sf)
library(tidyverse)
library(rnaturalearth)
library(lattice)
library(htmlwidgets)
library(widgetframe)
```


#### Create a map centred on the centre point of the UK. Add multiple basemaps and a layers control switch
```{r}
# Coordinates of the centre point of the UK: Whitendale Hanging Stones
whitendale = c(-2.547855, 54.00366)

l1 = leaflet() %>%
  # Centre map on Whitendale Hanging Stones
  setView(lng = whitendale[1], lat = whitendale[2], zoom = 6) %>% 
  # Add OSM basemap
  addProviderTiles(providers$OpenStreetMap, group = "Open Street Map") %>% 
  # Add additional basemap layers
  addProviderTiles(providers$Esri.WorldImagery, group = "ESRI World Imagery") %>% 
  addProviderTiles(providers$Esri.OceanBasemap, group = "ESRI Ocean Basemap") %>% 
  # Add a User-Interface (UI) control to switch layers
  addLayersControl(
    baseGroups = c("Open Street Map","ESRI World Imagery","ESRI Ocean Basemap"),
    options = layersControlOptions(collapsed = FALSE)
    )

# widgetframe::frameWidget() function only required to render Leaflet map in RMarkdown
frameWidget(l1, width = "100%", height = "500")
```
[Back to Contents](#contents)


<div id="2"/>
### 2. Add point data
Here, we download a boundary outline of the United Kingdom from the `rnaturalearth` package as an `sf` object. R Leaflet requires all spatial data to be supplied in longitude and latitude using WGS 84 (EPSG:4326). Then, we sample points randomly within the UK polygon and add these points to the map created in Step 1. 

#### Download a polygon outline of the UK and sample 100 random points
```{r}
# UK boundary outline
uk_outline = ne_countries(country = "United Kingdom", scale = "medium", returnclass = "sf") %>% 
  # Keep only geometry
  st_geometry() %>% 
  # Transform coordinate reference system (CRS) to WGS84
  st_transform(crs = 4326)
plot(uk_outline)

# Sample 100 random points within the UK polygon
set.seed(1234)
uk_pts = st_sample(uk_outline, size = 100)
plot(uk_pts, pch = 21, col = "black", bg = "yellow", add = TRUE)
```

#### Add points to the map as markers
This code adds the point data to the map as markers and a label for each marker appears on mouse hover.

```{r}
l2 = l1 %>%
  # Add point data with a label
  addMarkers(
    data = uk_pts,
     # Label appears on mouse hover
     label = paste("Label", seq(1:100)),
     # Options to customise the label text and size
     labelOptions = labelOptions(
       textsize = "14px", # text size
       style = list(
        "font-weight" = "bold", # bold text
        padding = "5px" # padding around text
        )
       )
    )

# widgetframe::frameWidget() function only required to render Leaflet map in RMarkdown
frameWidget(l2, width = "100%", height = "500")
```

#### Add tree icons instead of markers to represent the points
```{r}
# Link to icon
tree_icon = "https://cdn-icons-png.flaticon.com/512/490/490091.png"

l2 = l1 %>%
  # Add point data with a label
  addMarkers(
    data = uk_pts,
    group = "Tree icons",
    # Label appears on mouse hover
    label = paste("Label", seq(1:100)),
    # Options to customise the label text and size
    labelOptions = labelOptions(
      textsize = "14px", # text size
      style = list(
        "font-weight" = "bold", # bold text
        padding = "5px" # padding around text
      )
    ),
    # Change markers to custom icons
    icon = list(
      iconUrl = tree_icon,
      iconSize = c(20, 20)
      )
    )

# widgetframe::frameWidget() function only required to render Leaflet map in RMarkdown
frameWidget(l2, width = "100%", height = "500")
```
[Back to Contents](#contents)


<div id="3"/>
### 3. Add polygon data

#### Create a polygon using a bounding box of four coordinates
```{r}
# Boundary box
poly_df = data.frame(lon = c(-1.5,-0.9), lat = c(52.0,52.2))

# Convert to a polygon sf object
poly1 = st_as_sf(poly_df, coords = c("lon","lat"), crs = 4326) %>%
  st_bbox %>% 
  st_as_sfc %>% 
  st_as_sf
# plot(poly1)
```

#### Add polygon to the map
This code creates a blue polygon, the border of which is highlighted white on mouse hover and a popup label appears on mouse click.

```{r}
l3 = l2 %>%
  # Add polygon to map
  addPolygons(
    data = poly1,
    group = "Polygon 1",
    # stroke parameters
    weight = 3, color = "blue",
    # fill parameters
    fillColor = "blue", fillOpacity = 0.1,
    # Popup label
    popup = "Polygon 1",
    # Options to customise polygon highlighting
    highlightOptions = highlightOptions(
      # Highlight stroke parameters
      weight = 3, color = "white",
      # Highlight fill parameters
      fillColor = "blue", fillOpacity = 0.1
      )
    )

# widgetframe::frameWidget() function only required to render Leaflet map in RMarkdown
frameWidget(l3, width = "100%", height = "500")
```
[Back to Contents](#contents)

<div id="4"/>
### 4. Add popup graphs and images

#### Sample two additional random points within the UK boundary outline
```{r}
# Sample two random points and visualise on UK outline 
set.seed(1234)
uk_pts2 = st_sample(uk_outline, size = 2)
plot(uk_outline)
plot(uk_pts, pch = 21, col = "black", bg = "yellow", add = TRUE)
plot(uk_pts2, pch = 21, col = "black", bg = "red", add = TRUE)
```

#### Prepare graph and image examples to popup on mouse click
```{r}
# Example graph to show
graph1 = levelplot(t(volcano), col.regions = heat.colors(100), xlab = "", ylab = "")

# Example image to show (GIFs can also be used)
img1 = "https://www.r-project.org/logo/Rlogo.png"
# img1 = "https://upload.wikimedia.org/wikipedia/commons/d/d6/MeanMonthlyP.gif"
```

#### Add popup graph and image to the map
This code uses the `addPopupGraphs()` and `addPopupImages()` functions from the `leafpop` package. `addPopupGraphs()` expects a `list` of `lattice` or `ggplot2` objects, while `addPopupImages` expects a `vector` of file paths or web-URLs to image files. When using more than one graph or image, the number should be the same as the number of points for the popups to render correctly. You may also need to check that the order of the graphs or images matches that of the order of the points so that the correct popup appears on the correct point.

```{r}
l4 = l3 %>%
  # Add red circle point with a popup graph on mouse click
  addCircles(
    data = uk_pts2[1],
    # group argument essential for linking to popup graph
    group = "Circle point 1",
    # circle size
    radius = 10000,
    # circle stroke parameters
    weight = 1, color = "black",
    # circle fill parameterse
    fillColor = "red", fillOpacity = 0.8,
    # highlight options
    highlightOptions = highlightOptions(
      weight = 1, color = "white", fillOpacity = 0.8
      )
    ) %>% 
  # Add popup graph
  addPopupGraphs(
    graph = list(graph1), width = 200, height = 200,
    group = "Circle point 1"
    )%>%
  # Add red circle point with a popup image on mouse click
  addCircles(
    data = uk_pts2[2],
    # group argument essential for linking to popup image
    group = "Circle point 2",
    # circle size
    radius = 10000,
    # circle stroke parameters
    weight = 1, color = "black",
    # circle fill parameterse
    fillColor = "red", fillOpacity = 0.8,
    # highlight options
    highlightOptions = highlightOptions(
      weight = 1, color = "white", fillOpacity = 0.8
      )
    ) %>% 
  # Add popup image
  addPopupImages(
    image = img1, width = 100, height = 100,
    group = "Circle point 2"
    )

# widgetframe::frameWidget() function only required to render Leaflet map in RMarkdown
frameWidget(l4, width = "100%", height = "500")
```
[Back to Contents](#contents)


<div id="5"/>
### 5. Add extra customisation and widgets
This code enables the following:

- Button to reset the map view to its default setting
- Minimap display which can be toggled on or off
- Measurement widget to compute distances and areas
- Scale bar
- Layers control switch to toggle layers on or off
- Define the zoom levels for which layers are displayed

```{r}
l5 = l4 %>%
  # Reset map to default setting
  leaflet.extras::addResetMapButton() %>% 
  # Add an inset minimap
  addMiniMap(
    position = "topright",
    tiles = providers$Esri.WorldStreetMap,
    toggleDisplay = TRUE,
    minimized = FALSE
    ) %>%
  # Add measurement tool
  addMeasure(
    position = "topleft",
    primaryLengthUnit = "meters",
    secondaryLengthUnit = "kilometers",
    primaryAreaUnit = "sqmeters"
    ) %>%
  # Add scale bar
  addScaleBar(
    position = "bottomright",
    options = scaleBarOptions(imperial = FALSE)
    ) %>% 
  # Add a User-Interface (UI) control to switch layers
  addLayersControl(
    position = "topright",
    baseGroups = c("Open Street Map","ESRI World Imagery","ESRI Ocean Basemap"),
    # Add an option in layer control to toggle layers
    overlayGroups = c("Polygon 1","Circle point 1","Circle point 2","Tree icons"),
    # Choose to permanently display or collapse layers control switch
    options = layersControlOptions(collapsed = TRUE)
    ) %>% 
  # Only show tree icons at a defined zoom level
  groupOptions("Tree icons", zoomLevels = 8:20) 
```

<div id="6"/>
### 6. Final map
```{r echo=FALSE}
frameWidget(l5, width = "100%", height = "500")
```
[Back to Contents](#contents)


<div id="7"/>
### 7. Further resources and R session info

Leaflet for R: [vignette](https://rstudio.github.io/leaflet/)  
R package: [leaflet.extras](https://bhaskarvk.github.io/leaflet.extras/reference/index.html)  
R package: [leaflet.extras2](https://trafficonese.github.io/leaflet.extras2/)  
R package: [leafpop](https://github.com/r-spatial/leafpop)  
R package: [leafem](https://github.com/r-spatial/leafem)  
R package: [leafgl](https://github.com/r-spatial/leafgl)  


```{r}
sessionInfo()
```
